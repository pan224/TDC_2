# TDC模块重构说明

## 重构概述

将原来臃肿的 `tdc_eth_integrated.v` (530行) 重构为清晰的模块化架构,主模块现在只有 344 行,逻辑更加清晰。

## 新增模块列表

### 1. **tdc_clock_manager.v** - 时钟管理模块
**功能**: 集中管理所有TDC相关时钟生成
- 260MHz 主时钟
- 260MHz 四相位时钟 (0°/90°/180°/270°)

**优势**: 
- 时钟生成逻辑集中管理
- 易于维护和调试时钟问题
- 接口清晰明确

---

### 2. **tdc_reset_sync.v** - 复位同步模块
**功能**: 处理跨时钟域的复位信号同步
- 260MHz 时钟域复位同步
- 200MHz 时钟域复位同步
- 使用三级触发器链消除亚稳态

**优势**:
- 独立的复位同步逻辑,易于验证
- 标准的CDC(Clock Domain Crossing)处理
- 避免复位时序问题

---

### 3. **tdc_calib_ctrl.v** - 校准控制模块
**功能**: 管理TDC校准流程
- 自动校准: 上电后未就绪时自动执行
- 手动校准: 就绪后通过以太网命令触发
- 环形振荡器: 提供校准时钟源

**优势**:
- 校准逻辑独立封装
- 状态机清晰可见
- 易于扩展校准策略

---

### 4. **tdc_signal_mux.v** - 信号多路复用模块
**功能**: 管理测量信号的多路复用
- 第一级: 外部信号 vs 扫描测试信号
- 第二级: 测量信号 vs 校准信号 (使用BUFGCTRL)

**信号路径**:
```
正常模式:     外部信号 → TDC通道
扫描测试模式: 内部测试脉冲 → TDC通道
校准模式:     环形振荡器 → TDC通道
```

**优势**:
- 信号路径清晰可见
- 易于添加新的信号源
- BUFGCTRL使用规范

---

### 5. **tdc_timestamp_capture.v** - 时间戳捕获模块
**功能**: 捕获双通道TDC测量结果
- 全局粗计数器管理 (16位)
- 事件ID管理 (每个通道独立8位ID)
- 边沿检测防止重复触发
- 测量周期ID管理

**数据结构**:
```
UP通道:   [8位事件ID] + [16位粗计数] + [13位精细时间] = 37位
DOWN通道: [8位事件ID] + [16位粗计数] + [13位精细时间] = 37位
```

**优势**:
- 时间戳捕获逻辑集中
- 防止重复触发机制
- 清晰的事件跟踪

---

### 6. **tdc_cdc_sync.v** - 跨时钟域同步模块
**功能**: 处理所有跨时钟域信号同步 (200MHz ↔ 260MHz)
- 手动校准触发信号: 200MHz → 260MHz
- 扫描命令触发信号: 200MHz → 260MHz
- 扫描命令参数: 200MHz → 260MHz

**实现方式**:
- 三级触发器同步链 (标准CDC处理)
- ASYNC_REG约束确保布局
- 边沿检测产生脉冲

**优势**:
- CDC逻辑集中管理
- 符合时序约束标准
- 易于验证和调试

---

## 重构后的主模块结构

`tdc_eth_integrated.v` 现在只负责模块间的连接和顶层逻辑:

```
tdc_eth_integrated
├── tdc_clock_manager        (时钟生成)
├── tdc_reset_sync           (复位同步)
├── tdc_cdc_sync             (跨时钟域同步)
├── tdc_calib_ctrl           (校准控制)
├── tdc_scan_ctrl            (扫描测试控制)
├── tdc_signal_mux           (信号多路复用)
├── tdc_timestamp_capture    (时间戳捕获)
├── channel (UP通道)         (TDC测量通道1)
├── channel (DOWN通道)       (TDC测量通道2)
└── eth_comm_ctrl_tdc        (以太网通信)
```

## 重构优势

### 1. **可读性提升**
- 主模块从 530 行缩减到 344 行
- 每个子模块职责单一,易于理解
- 模块命名清晰,一目了然

### 2. **可维护性提升**
- 修改某个功能只需修改对应模块
- 减少了修改引入错误的风险
- 易于定位问题

### 3. **可测试性提升**
- 每个模块可以独立仿真测试
- 便于编写单元测试
- 易于验证CDC逻辑

### 4. **可复用性提升**
- 子模块可以在其他项目中复用
- 例如: tdc_reset_sync 可用于任何需要跨时钟域复位的场景
- tdc_cdc_sync 可作为通用CDC同步模板

### 5. **开发效率提升**
- 多人协作时可以并行开发不同模块
- 易于代码审查
- 降低学习成本

## 时钟域说明

### 260MHz 时钟域
- TDC测量核心
- 时间戳捕获
- 粗计数器
- 校准控制

### 200MHz 时钟域
- 以太网通信
- 命令接收
- 数据发送

### 跨时钟域信号
所有跨时钟域信号都经过 `tdc_cdc_sync` 模块处理,确保时序安全。

## 接口保持不变

重构后的 `tdc_eth_integrated` 模块接口完全保持不变,因此:
- ✅ 顶层模块 `test_tdc_eth.v` 无需修改
- ✅ 引脚约束无需修改
- ✅ IP核连接无需修改

## 使用建议

1. **综合时检查**: 确认所有新模块都被正确添加到项目中
2. **时序约束**: CDC同步路径已添加ASYNC_REG约束
3. **仿真验证**: 建议对每个新模块进行单独仿真验证
4. **逐步集成**: 可以先验证时钟和复位模块,再集成其他模块

## 文件清单

新增文件:
- `tdc_clock_manager.v`
- `tdc_reset_sync.v`
- `tdc_calib_ctrl.v`
- `tdc_signal_mux.v`
- `tdc_timestamp_capture.v`
- `tdc_cdc_sync.v`

修改文件:
- `tdc_eth_integrated.v` (重构,接口不变)

保持不变:
- `test_tdc_eth.v`
- `channel.v`
- `eth_comm_ctrl_tdc.v`
- 其他所有文件

---

**重构完成日期**: 2025年12月10日
**重构目标**: 提高代码质量和可维护性 ✅
